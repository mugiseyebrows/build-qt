{% set majmin = ver.rsplit(".", 1)[0] %}
{% set qwt_ver = "6.3.0" %}
{% set qwt_ref = "v6.3.0" %}
{% set host = "qt.mirror.constant.com" %}
use-patch-var 1

def qtbase
    # call pull-mingw
    add_path(C:\mingw1310_64\bin)
    # call pull-mysql
    add_path(C:\mysql-8.2.0-winx64\bin)
    add_path(C:\mysql-8.2.0-winx64\lib)
    # call pull-postgresql
    add_path(C:\postgresql-14\bin)
    use(python, 3.13)
    install(ninja)
    install(mugideploy)
    use(cmake)
    if_exist_return(C:\Qt\{{ver}}\mingw_64\bin\qmake.exe)
    where(gcc, cmake, ninja, libpq.dll, libmysql.dll, mugideploy, :assert)
    pushd_cd()
        download(https://{{host}}/official_releases/qt/{{majmin}}/{{ver}}/submodules/qtbase-everywhere-src-{{ver}}.zip, :cache, :v)
        unzip(qtbase-everywhere-src-{{ver}}.zip, :test=qtbase-everywhere-src-{{ver}})
        pushd qtbase-everywhere-src-{{ver}}
            cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=C:/Qt/{{ver}}/mingw_64 -DQT_QMAKE_TARGET_MKSPEC=win32-g++ -DQT_BUILD_TESTS=FALSE -DQT_BUILD_EXAMPLES=FALSE -DFEATURE_system_zlib=OFF -DFEATURE_sql_mysql=ON -DFEATURE_sql_psql=ON -DPostgreSQL_ROOT=C:/postgresql-14 -DMySQL_ROOT=C:/mysql-8.2.0-winx64 .
            cmake --build . --parallel || exit /b 1
            cmake --install . || exit /b 1
            mugideploy copy-dep --bin C:\Qt\{{ver}}\mingw_64\bin\qmake.exe --dst C:\Qt\{{ver}}\mingw_64\bin
            mugideploy copy-dep --bin C:\mysql-8.2.0-winx64\lib\libmysql.dll --dst C:\Qt\{{ver}}\mingw_64\bin
            mugideploy copy-dep --bin C:\postgresql-14\lib\libpq.dll --dst C:\Qt\{{ver}}\mingw_64\bin
            copy(mugideploy.log, ..\mugideploy.log)
        popd
    popd
    where(qmake, :assert)

def qtsvg depends on qtbase
    use(ninja)
    use(cmake)
    add_path(C:\Qt\{{ver}}\mingw_64\bin)
    if_exist_return(C:\Qt\{{ver}}\mingw_64\bin\Qt6Svg.dll)
    where(gcc, cmake, ninja, :assert)
    download(https://{{host}}/official_releases/qt/{{majmin}}/{{ver}}/submodules/qtsvg-everywhere-src-{{ver}}.zip, :cache, :v)
    unzip(qtsvg-everywhere-src-{{ver}}.zip, :t=qtsvg-everywhere-src-{{ver}})
    pushd qtsvg-everywhere-src-{{ver}}
        mkdir(build)
        pushd build
            cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="C:\Qt\{{ver}}\mingw_64" -DCMAKE_TOOLCHAIN_FILE=C:\Qt\{{ver}}\mingw_64\lib\cmake\Qt6\qt.toolchain.cmake ..
            cmake --build . --parallel || exit /b 1
            cmake --install . || exit /b 1
        popd
    popd

def qtactiveqt depends on qtbase
    use(ninja)
    use(cmake)
    add_path(C:\Qt\{{ver}}\mingw_64\bin)
    if_exist_return(C:\Qt\{{ver}}\mingw_64\lib\libQt6AxContainer.a)
    where(gcc, cmake, ninja, :assert)
    download(https://{{host}}/official_releases/qt/{{majmin}}/{{ver}}/submodules/qtactiveqt-everywhere-src-{{ver}}.zip, :cache, :v)
    unzip(qtactiveqt-everywhere-src-{{ver}}.zip, :t=qtactiveqt-everywhere-src-{{ver}})
    pushd qtactiveqt-everywhere-src-{{ver}}
        mkdir(build)
        pushd build
            cmake -G Ninja -DCMAKE_INSTALL_PREFIX="C:\Qt\{{ver}}\mingw_64" -DCMAKE_TOOLCHAIN_FILE=C:\Qt\{{ver}}\mingw_64\lib\cmake\Qt6\qt.toolchain.cmake ..
            cmake --build . --parallel || exit /b 1
            cmake --install . || exit /b 1
        popd
    popd

def qserialport depends on qtbase
    if_exist_return(C:\Qt\{{ver}}\mingw_64\bin\Qt6SerialPort.dll)
    download(https://{{host}}/official_releases/qt/{{majmin}}/{{ver}}/submodules/qtserialport-everywhere-src-{{ver}}.zip, :cache, :v)
    unzip(qtserialport-everywhere-src-{{ver}}.zip, :t=qtserialport-everywhere-src-{{ver}})
    pushd qtserialport-everywhere-src-{{ver}}
        mkdir(build)
        pushd build
            cmake -G Ninja -DCMAKE_INSTALL_PREFIX="C:\Qt\{{ver}}\mingw_64" -DCMAKE_TOOLCHAIN_FILE=C:\Qt\{{ver}}\mingw_64\lib\cmake\Qt6\qt.toolchain.cmake ..
            cmake --build . --parallel || exit /b 1
            cmake --install . || exit /b 1
        popd
    popd

def qtimageformats depends on qtbase
    if_exist_return(C:\qt\{{ver}}\mingw_64\plugins\imageformats\qwebp.dll)
    download(https://{{host}}/official_releases/qt/{{majmin}}/{{ver}}/submodules/qtimageformats-everywhere-src-{{ver}}.zip, qtimageformats-everywhere-src-{{ver}}.zip, :cache, :v)
    unzip(qtimageformats-everywhere-src-{{ver}}.zip, :t=qtimageformats-everywhere-src-{{ver}})
    pushd qtimageformats-everywhere-src-{{ver}}
        mkdir(build)
        pushd build
            cmake -G Ninja -DCMAKE_INSTALL_PREFIX="C:\Qt\{{ver}}\mingw_64" -DCMAKE_TOOLCHAIN_FILE=C:\Qt\{{ver}}\mingw_64\lib\cmake\Qt6\qt.toolchain.cmake ..
            cmake --build . --parallel || exit /b 1
            cmake --install . || exit /b 1
        popd
    popd

def qwt depends on qtbase qtsvg
    git_clone(https://git.code.sf.net/p/qwt/git, qwt, :ref={{qwt_ref}})
    where(gcc, qmake, mingw32-make, :assert)
    if_exist_return(C:\Qwt-{{qwt_ver}}-Qt-{{ver}}\lib\qwt.dll)
    pushd qwt
        patch(../0001-release-no-examples-no-tests-install-prefix.patch, :p1, :N)
        qmake
        mingw32-make -j4
        mingw32-make install
    popd

def main depends on qtbase qtsvg qtactiveqt qserialport qtimageformats qwt
    zip(Qt-{{ver}}.zip, C:\Qt\{{ver}}\mingw_64)
    zip(Qwt-{{qwt_ver}}-Qt-{{ver}}.zip, C:\Qwt-{{qwt_ver}}-Qt-{{ver}})